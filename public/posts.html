<script>
const token = localStorage.getItem("token");
if(!token) location.href="/login.html";

const usersDiv = document.getElementById("users");
const feed = document.getElementById("feed");

/* LOGOUT */
function logout(){
  localStorage.removeItem("token");
  location.href="/login.html";
}

/* CREAR POST */
function createPost(){
  fetch("/create-post",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({
      text: text.value,
      image: image.value
    })
  }).then(()=>{
    text.value="";
    image.value="";
    loadPosts();
  });
}

/* LIKE */
function toggleLike(id){
  fetch("/like/"+id,{
    method:"POST",
    headers:{ Authorization:"Bearer "+token }
  }).then(loadPosts);
}

/* COMENTAR */
function addComment(id,input){
  if(!input.value.trim()) return;

  fetch("/comment",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({
      postId:id,
      text:input.value
    })
  }).then(()=>{
    input.value="";
    loadComments(id);
  });
}

/* CARGAR COMENTARIOS */
function loadComments(id){
  fetch("/comments/"+id,{
    headers:{ Authorization:"Bearer "+token }
  })
  .then(r=>r.json())
  .then(c=>{
    const box=document.getElementById("c"+id);
    box.innerHTML="";
    c.forEach(x=>{
      box.innerHTML+=
        `<div class="comment"><b>${x.name}:</b> ${x.comment}</div>`;
    });
  });
}

/* CARGAR POSTS */
function loadPosts(){
  fetch("/get-posts",{
    headers:{ Authorization:"Bearer "+token }
  })
  .then(r=>r.json())
  .then(posts=>{
    feed.innerHTML="";
    posts.forEach(p=>{
      const d=document.createElement("div");
      d.className="post";
      d.innerHTML=`
        <b>${p.name}</b><br>
        <small>${new Date(p.created_at).toLocaleString()}</small>
        <p>${p.text||""}</p>
        ${p.image?`<img src="${p.image}">`:""}
        <button class="like" onclick="toggleLike(${p.id})">üëç ${p.likes}</button>
        <div id="c${p.id}"></div>
        <input placeholder="Comentar..."
          onkeydown="if(event.key==='Enter')addComment(${p.id},this)">
      `;
      feed.appendChild(d);
      loadComments(p.id);
    });
  });
}

/* CARGAR USUARIOS */
function loadUsers(){
  fetch("/users",{
    headers:{ Authorization:"Bearer "+token }
  })
  .then(r=>r.json())
  .then(users=>{
    usersDiv.innerHTML="";
    users.forEach(u=>{
      const d=document.createElement("div");
      d.className="user";
      d.innerText=u.name;
      d.onclick=()=>alert("Chat privado con "+u.name+" (siguiente paso)");
      usersDiv.appendChild(d);
    });
  });
}

loadPosts();
loadUsers();
</script>
